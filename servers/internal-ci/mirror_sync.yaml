- job-template: &mirror-mirror_path-mirror_name
    name: 'mirror-{mirror_path}-{mirror_name}'
    description: |
        This job will fetch remote upstream repo to timestamp<br>
        It and serve it using http and rsync protocols.<br><br>
        Default variable (SYNC_LOCATIONS) set multiple additional external targets in different locations.<br>
        Maintenance contacts: #fuel-build
    node: mirror-pkgs-seed

    parameters:
      - string:
          name: SOURCE_URL
          default: '{src_url}'
          description: 'Url to make mirror of. (supported by rsync)'
      - string:
          name: MIRROR_DIR
          default: '{mirror_dir}'
          description: |
              Destination directory on main mirror. %symlink_target% gets automaticaly managed and
              mean the target of SOURCE_URL parameter if it is symlink
      - string:
          name: SYNC_LOCATIONS
          default: '{sync_locations}'
          description: 'List of other rsync mirrors to synchronize. (" " separate values)'
      - string:
          name: SNAPSHOT_LIFETIME
          default: '30'
          description: |
              Maximum lifetime of snapshot (number of days). '0' mean that old
              snapshots will not be deleted. 'None' mean that all snapshots excluding
              latest will be deleted.
      - string:
          name: UPDATED_SYMLINKS
          default: '{updated_symlinks}'
          description: |
              List of symlinks to current snapshot separated by the space.
              %symlink_target% gets automaticaly managed and mean the target of SOURCE_URL
              parameter if it is symlink
      - string:
          name: TIMESTAMP
          default: ''
          description: 'Use specified timestamp instead of autogenerated. (YYYY-MM-DD-hhmmss)'
      - string:
          name: PULL_RSYNC_EXTRA_PARAMS
          default: '{pull_rsync_extra_params}'
          description: |
              Extra parameters that will be received to rsync (for pull from
              source only). PLEASE ESCAPE FIRST "-". For example correct value
              is "\--dry-run -l".

    wrappers:
      - ssh-agent-credentials:
          users:
            - '55e5b205-a099-4efd-8fca-110bbb5714fc'

    builders:
      - shell:
          !include-raw-escape: './builders/mirror_pull_push.sh'

    triggers:
        - timed: '0 3 * * *'
    publishers:
      - email:
          recipients: fuel-build+alert@mirantis.com
      - junit:
          results: '*.xml'


- job-template:
    <<: *mirror-mirror_path-mirror_name
    name: 'mirror-{mirror_path}-{mirror_name}-{mirror_version}'


- project:
    name: mirror-sync
    jobs:
      - 'mirror-{mirror_path}-{mirror_name}':
          mirror_path: pkgs
          mirror_name: ubuntu
          mirror_dir: '{mirror_name}'
          src_url: 'rsync://cz.archive.ubuntu.com/{mirror_name}'
          sync_locations: >
              rsync://seed01-bud.infra.mirantis.net/mirror-sync/{mirror_path}
              rsync://seed01-bud.fuel-infra.org/mirror-sync/{mirror_path}
              rsync://seed01-scc.fuel-infra.org/mirror-sync/{mirror_path}
          updated_symlinks: '{mirror_name}'
          pull_rsync_extra_params: ''
      - 'mirror-{mirror_path}-{mirror_name}':
          mirror_path: mirrors
          mirror_name: docker
          mirror_dir: '{mirror_name}'
          src_url: 'rsync://mirror.yandex.ru/mirrors/docker/'
          sync_locations: >
              rsync://mirror.seed-us1.fuel-infra.org/mirror-sync/{mirror_path}
              rsync://mirror.seed-cz1.fuel-infra.org/mirror-sync/{mirror_path}
              rsync://seed01-bud.infra.mirantis.net/mirror-sync/{mirror_path}
              rsync://seed01-bud.fuel-infra.org/mirror-sync/{mirror_path}
              rsync://seed01-scc.fuel-infra.org/mirror-sync/{mirror_path}
          updated_symlinks: '{mirror_name}'
          pull_rsync_extra_params: '\--exclude .temp --exclude .lastsync --exclude .mirror.yandex.ru'

      - 'mirror-{mirror_path}-{mirror_name}-{mirror_version}':
          mirror_path: pkgs
          mirror_name: centos
          mirror_version: 6
          mirror_dir: '{mirror_name}%symlink_target%'
          src_url: 'rsync://ftp.fi.muni.cz/pub/linux/{mirror_name}/{mirror_version}'
          sync_locations: >
              rsync://seed01-bud.infra.mirantis.net/mirror-sync/{mirror_path}
              rsync://seed01-bud.fuel-infra.org/mirror-sync/{mirror_path}
              rsync://seed01-scc.fuel-infra.org/mirror-sync/{mirror_path}
          updated_symlinks: '{mirror_name}-%symlink_target% {mirror_name}/{mirror_version} {mirror_name}/%symlink_target%'
          pull_rsync_extra_params: '\--exclude=isos'
      - 'mirror-{mirror_path}-{mirror_name}-{mirror_version}':
          mirror_path: pkgs
          mirror_name: centos
          mirror_version: 7
          mirror_dir: '{mirror_name}%symlink_target%'
          src_url: 'rsync://ftp.fi.muni.cz/pub/linux/{mirror_name}/{mirror_version}'
          sync_locations: >
              rsync://seed01-bud.infra.mirantis.net/mirror-sync/{mirror_path}
              rsync://seed01-bud.fuel-infra.org/mirror-sync/{mirror_path}
              rsync://seed01-scc.fuel-infra.org/mirror-sync/{mirror_path}
          updated_symlinks: '{mirror_name}-%symlink_target% {mirror_name}/{mirror_version} {mirror_name}/%symlink_target%'
          pull_rsync_extra_params: '\--exclude=isos'
