#
# Template used to run the plugin's unit tests
#
# If the unit tests pass, the job will start the deployment test
#
- job-template:
    name: '{version}.fuel-plugin.{plugin_name}.verify'
    node: '{node_label}'
    project-type: multijob

    description: |
      Job used to run the unit tests of <b>fuel-plugin-{plugin_name}</b><ul>
      <li><b>Repository:</b>
        <a href="https://github.com/openstack/{plugin_repo}">
          https://github.com/openstack/{plugin_repo}
        </a>
      </li>
      <li><b>Branch:</b> {plugin_branch}</li>
      <li><b>Owner:</b> {plugin_owner}</li>
      </ul>

    parameters:
      - string:
          name: GERRIT_REFSPEC
          default: 'refs/heads/{plugin_branch}'

    scm:
      - review-openstack-org:
          project-basedir: '{plugin_dir}'
          project-name: 'openstack/{plugin_repo}'
      - git:
          basedir: 'trsync'
          branches:
            - master
          url: 'https://review.fuel-infra.org/infra/trsync'

    triggers:
      - review-openstack-org:
          project-branch-pattern: '{plugin_branch}'
          project-name-pattern: 'openstack/{plugin_repo}'

    wrappers:
      - ssh-agent-credentials:
          users:
            - '{ssh-creds-plugin-publisher}'

    builders:
      - inject:
          # Define the directory containing the plugin project
          properties-content: |
            PLUGIN_DIR={plugin_dir}
            PLUGIN_NAME={plugin_name}
            PLUGIN_BRANCH={plugin_branch}
            PLUGIN_USER={username-plugin-publisher}
      - shell:
          # verify&build plugin
          !include-raw-escape: ./builders/plugin-verify.sh
      - inject:
          # pass parameters from verify&build script
          properties-file: plugin-verify.envfile
      - shell:
          # publish plugin
          !include-raw-escape: ./builders/plugin-publish.sh
      - multijob:
          name: Test plugin
          condition: SUCCESSFUL
          projects:
            - name: '{version}.fuel-plugin.{plugin_name}.deploy-test'
              kill-phase-on: FAILURE
              node-parameters: true
              # Content of this file is generated by builders/plugin-publish.sh
              property-file: plugin-publish.envfile

    publishers:
      - archive:
          artifacts: 'plugin/*.rpm'
