#
# Template used to define the tests validating the StackLight plugins at
# periodic intervals (eg daily)
#
- job-template:
    name: '{version}.stacklight.{plugin_branch}.runner'
    node: '{node_label}'
    project-type: multijob

    triggers:
      - timed: '{timer}'

    description: |
      Job used to build and validate the StackLight plugins<ul>
      <li><b>Branch for StackLight plugins:</b> {plugin_branch}</li>
      <li><b>MOS version:</b> {version}</li>
      <li><b>Plugin owner:</b> {plugin_owner}</li>
      </ul>

    builders:
      - inject:
          # Define the directory where the plugins have been checked out
          properties-content: |
            PLUGINS_DIR=$WORKSPACE/plugins
      - shell:
          !include-raw-escape: ./builders/build-stacklight-plugins.sh
      - multijob:
          name: 'Run the system tests'
          condition: SUCCESSFUL
          projects:
            - name: '{version}.stacklight.{plugin_branch}.deploy_toolchain'
            - name: '{version}.stacklight.{plugin_branch}.deploy_ha_toolchain'

    publishers:
      - archive:
          artifacts: 'plugins/*.rpm'

    scm:
      - fuel-plugins:
          project-refspec: refs/heads/master
      - fuel-plugin-repository:
          project-basedir: 'plugins/fuel-plugin-elasticsearch-kibana'
          project-name: 'elasticsearch-kibana'
          project-branch: '{plugin_branch}'
      - fuel-plugin-repository:
          project-basedir: 'plugins/fuel-plugin-influxdb-grafana'
          project-name: 'influxdb-grafana'
          project-branch: '{plugin_branch}'
      - fuel-plugin-repository:
          project-basedir: 'plugins/fuel-plugin-lma-infrastructure-alerting'
          project-name: 'lma-infrastructure-alerting'
          project-branch: '{plugin_branch}'
      - fuel-plugin-repository:
          project-basedir: 'plugins/fuel-plugin-lma-collector'
          project-name: 'lma-collector'
          project-branch: '{plugin_branch}'
      - fuel-plugin-repository:
          project-basedir: 'plugins/fuel-plugin-detach-database'
          project-name: 'detach-database'
          project-branch: '{detached_plugin_branch}'
      - fuel-plugin-repository:
          project-basedir: 'plugins/fuel-plugin-detach-rabbitmq'
          project-name: 'detach-rabbitmq'
          project-branch: '{detached_plugin_branch}'

    wrappers:
      - timeout:
          fail: false
          timeout: 360
          write-description: false


#
# Job group used to realize all the deployment and functional jobs of the
# StackLight toolchain
#
- job-group:
   name: '{version}.stacklight.{plugin_branch}.tests'
   description: 'Deployment and functional tests of the StackLight toolchain ({plugin_branch} branch) on MOS {version}'
   timeout: '480'
   jobs:
     - '{version}.stacklight.{plugin_branch}.{test_group}':
        # Content of this file is generated by build-stacklight-plugins.sh
        property-file: stacklight-build.jenkins-injectfile
        node-parameters: true
        kill-phase-on: NEVER
        test_group: deploy_toolchain
     - '{version}.stacklight.{plugin_branch}.{test_group}':
        # Content of this file is generated by build-stacklight-plugins.sh
        property-file: stacklight-build.jenkins-injectfile
        node-parameters: true
        kill-phase-on: NEVER
        test_group: deploy_ha_toolchain

#
# Template used to test the deployment of the StackLight toolchain
#
- job-template:
    name: '{version}.stacklight.{plugin_branch}.{test_group}'

    builders:
      - guess-mirror
      - iso-download
      - inject:
          # Define the default variables used for systest
          properties-content: |
            VENV_PATH=$WORKSPACE/venv_test
            OPENSTACK_RELEASE=ubuntu
            POOL_DEFAULT=10.109.0.0/16:24
            CONNECTION_STRING=qemu+tcp://127.0.0.1:16509/system
      - plugin-prepare-env-fuel-qa-plugins
      - shell:
          !include-raw-escape: ./builders/deploy-test-stacklight.sh

    description: |
      Job used to deploy and test the StackLight toolchain<ul>
      <li><b>Branch for StackLight plugins:</b> {plugin_branch}</li>
      <li><b>MOS version:</b> {version}</li>
      <li><b>Test group:</b> {test_group}</li>
      </ul>

    parameters:
      - string:
          description: Source for ISO
          name: MAGNET_LINK
          default: '{iso_magnet_link}'
      - string:
          name: ENV_PREFIX
          default: '{version}.stacklight.{plugin_branch}.{test_group}'
          description: 'Environment prefix used for systest'
      - string:
          name: FUELQA_GITREF
          default: '{fuel_qa_branch}'
          description: 'Git reference to the fuel-qa repository'
      - string:
          name: TEST_GROUP
          default: '{test_group}'
          description: 'Test group used in systest'

    properties:
      - throttle:
          max-per-node: 1
          option: project
      - heavy-job:
          weight: 6

    publishers:
      - archive:
          allow-empty: true
          artifacts: '**/nosetests.xml,logs/*'
          latest-only: false
      - post-destroy-vms(build-timeout)
      - description-setter:
          regexp: "'Description string: (.*)'"
          regexp-for-failed: "'Description string: (.*)'"

    scm:
      - git:
          basedir: ''
          branches:
            - 'master'
          clean:
            before: true
          url: 'https://github.com/openstack/stacklight-integration-tests'

    wrappers:
      - timeout:
          fail: false
          timeout: 360
          write-description: false

